import { Telegraf } from 'telegraf';
import dotenv from 'dotenv';

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
dotenv.config();

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
const bot = new Telegraf(process.env.TELEGRAM_BOT_TOKEN!);

console.log('ü§ñ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞...');

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
bot.start(async (ctx) => {
  console.log(`–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${ctx.from?.username || ctx.from?.first_name}`);
  
  const welcomeMessage = `–≠–π, –π–æ—É! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Total Lookas! –ú—ã —Å–æ–∑–¥–∞–µ–º –∫–ª–∞—Å—Å–Ω—ã–π –º–µ—Ä—á –∏ –º–æ–∂–µ–º —Å–¥–µ–ª–∞—Ç—å —Ç–µ–±–µ!

–í—Å—ë –ø—Ä–æ—Å—Ç–æ:
1. –ù–∞–∂–º–∏ ¬´–ù–ê–ß–ê–¢–¨¬ª
2. –í—ã–±–µ—Ä–∏ –Ω—É–∂–Ω—ã–µ –æ–ø—Ü–∏–∏
3. –£–∫–∞–∂–∏ —Ç–∏—Ä–∞–∂
4. –ü–æ–ª—É—á–∏ –≥–æ—Ç–æ–≤–æ–µ –ö–ü`;

  await ctx.reply(welcomeMessage, {
    reply_markup: {
      inline_keyboard: [
        [
          { text: 'ÔøΩ –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', callback_data: 'open_app' }
        ],
        [
          { text: 'ÔøΩ –ö–æ–Ω—Ç–∞–∫—Ç—ã', callback_data: 'contact' },
          { text: 'ÔøΩ –û –Ω–∞—Å', callback_data: 'about' }
        ]
      ]
    }
  });
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
bot.action('open_app', async (ctx) => {
  await ctx.answerCbQuery();
  
  await ctx.reply(`üöÄ –ö–∞—Ç–∞–ª–æ–≥ Total Lookas

üî∏ –§—É—Ç–±–æ–ª–∫–∏ (–æ—Ç 500‚ÇΩ)
üî∏ –ü–æ–ª–æ (–æ—Ç 800‚ÇΩ)  
üî∏ –•—É–¥–∏ (–æ—Ç 1200‚ÇΩ)
üî∏ –¢–æ–ª—Å—Ç–æ–≤–∫–∏ (–æ—Ç 1000‚ÇΩ)
üî∏ –ö—É—Ä—Ç–∫–∏ (–æ—Ç 2000‚ÇΩ)

üì± –û—Ç–∫—Ä—ã–≤–∞–π—Ç–µ –∫–∞—Ç–∞–ª–æ–≥ –∏ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –ö–ü:
üîó http://localhost:3000/catalog

‚ö†Ô∏è –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –±—É–¥–µ—Ç WebApp –∫–Ω–æ–ø–∫–∞ —Å HTTPS`, {
    reply_markup: {
      inline_keyboard: [
        [{ text: '‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é', callback_data: 'back_to_menu' }]
      ]
    }
  });
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫
bot.action('about', async (ctx) => {
  await ctx.answerCbQuery();
  await ctx.reply(`üè¢ –û –∫–æ–º–ø–∞–Ω–∏–∏ Total Lookas

–ú—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π –æ–¥–µ–∂–¥—ã:

‚úÖ –§—É—Ç–±–æ–ª–∫–∏, –ø–æ–ª–æ, —Ö—É–¥–∏
‚úÖ –ù–∞–Ω–µ—Å–µ–Ω–∏–µ –≤–∞—à–µ–≥–æ –ª–æ–≥–æ—Ç–∏–ø–∞
‚úÖ –ë—ã—Å—Ç—Ä—ã–µ —Å—Ä–æ–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞
‚úÖ –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ —Ü–µ–Ω—ã

–†–∞–±–æ—Ç–∞–µ–º —Å –∫–æ–º–ø–∞–Ω–∏—è–º–∏ –ª—é–±–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞!`);
});

bot.action('contact', async (ctx) => {
  await ctx.answerCbQuery();
  await ctx.reply(`    await ctx.answerCbQuery();
    ctx.reply('–ù–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã:
üìß Email: info@totallookas.com
üì± Instagram: @totallookas
üìû –¢–µ–ª–µ—Ñ–æ–Ω: +7 (XXX) XXX-XX-XX');
  } else if (action === 'about_us') {
    await ctx.answerCbQuery();
    ctx.reply('Total Lookas ‚Äî —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∞—è—Å—è –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –æ–¥–µ–∂–¥—ã —Å –≤–∞—à–µ–π —Å–∏–º–≤–æ–ª–∏–∫–æ–π.

‚ú® –ú—ã —Å–æ–∑–¥–∞–µ–º:
üî∏ –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—É—é –æ–¥–µ–∂–¥—É
üî∏ –ú–µ—Ä—á –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–π
üî∏ –£–Ω–∏—Ñ–æ—Ä–º—É
üî∏ –ü—Ä–æ–º–æ-–ø—Ä–æ–¥—É–∫—Ü–∏—é

–ú—ã —Ä–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏ –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º.');
  } else if (action === 'back_to_menu') {
    await ctx.answerCbQuery();
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é
    await ctx.reply(`–≠–π, –π–æ—É! üëã

Total Lookas ‚Äî —ç—Ç–æ –±—Ä–µ–Ω–¥ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π –æ–¥–µ–∂–¥—ã –∏ –º–µ—Ä—á–∞. –ú—ã –¥–µ–ª–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤–µ—â–∏ —Å –≤–∞—à–µ–π —Å–∏–º–≤–æ–ª–∏–∫–æ–π! üî•

üéØ –ß—Ç–æ –º–æ–∂–µ–º –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å:
- –§—É—Ç–±–æ–ª–∫–∏, –ø–æ–ª–æ, —Ö—É–¥–∏
- –¢–æ–ª—Å—Ç–æ–≤–∫–∏ –∏ –∫—É—Ä—Ç–∫–∏  
- –ë—Ä–µ–Ω–¥–∏–Ω–≥ –∏ –ª–æ–≥–æ—Ç–∏–ø—ã
- –ë—ã—Å—Ç—Ä–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ

–ì–æ—Ç–æ–≤—ã —Å–æ–∑–¥–∞—Ç—å —á—Ç–æ-—Ç–æ –∫—Ä—É—Ç–æ–µ? üí™`, {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'üõçÔ∏è –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', callback_data: 'open_app' }],
          [
            { text: 'üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã', callback_data: 'contacts' },
            { text: '‚ÑπÔ∏è –û –Ω–∞—Å', callback_data: 'about_us' }
          ]
        ]
      }
    });
  }
});`);
});

bot.action('catalog', async (ctx) => {
  await ctx.answerCbQuery();
  
  await ctx.reply(`üëï –ö–∞—Ç–∞–ª–æ–≥ Total Lookas

üî∏ –§—É—Ç–±–æ–ª–∫–∏ (–æ—Ç 500‚ÇΩ)
üî∏ –ü–æ–ª–æ (–æ—Ç 800‚ÇΩ)  
üî∏ –•—É–¥–∏ (–æ—Ç 1200‚ÇΩ)
üî∏ –¢–æ–ª—Å—Ç–æ–≤–∫–∏ (–æ—Ç 1000‚ÇΩ)
üî∏ –ö—É—Ä—Ç–∫–∏ (–æ—Ç 2000‚ÇΩ)

üì± –î–ª—è –ø–æ–ª–Ω–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∑–∞–∫–∞–∑–∞ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ:
üîó http://localhost:3000/catalog

‚ö†Ô∏è –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –±—É–¥–µ—Ç WebApp –∫–Ω–æ–ø–∫–∞ —Å HTTPS`, {
    reply_markup: {
      inline_keyboard: [
        [{ text: '‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é', callback_data: 'back_to_menu' }]
      ]
    }
  });
});

bot.action('proposal', async (ctx) => {
  await ctx.answerCbQuery();
  
  await ctx.reply(`üí∞ –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:

–í—ã –º–æ–∂–µ—Ç–µ:
1Ô∏è‚É£ –ù–∞–ø–∏—Å–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É: @totalookas_support
2Ô∏è‚É£ –ò–ª–∏ –ø–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ö–ü:
üîó http://localhost:3000/catalog

‚ö†Ô∏è –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –±—É–¥–µ—Ç WebApp –∫–Ω–æ–ø–∫–∞ —Å HTTPS`, {
    reply_markup: {
      inline_keyboard: [
        [{ text: '‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é', callback_data: 'back_to_menu' }]
      ]
    }
  });
});

// –ö–æ–º–∞–Ω–¥–∞ /webapp –¥–ª—è –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
bot.command('webapp', async (ctx) => {
  await ctx.reply(`üõçÔ∏è –ö–∞—Ç–∞–ª–æ–≥ Total Lookas:

üì± –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://localhost:3000/catalog

‚ö†Ô∏è –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ WebApp –∫–Ω–æ–ø–∫–∞ —Å HTTPS URL`);
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∞–Ω–Ω—ã—Ö –∏–∑ WebApp
bot.on('web_app_data', async (ctx) => {
  try {
    if (!ctx.webAppData?.data) {
      console.error('WebApp data is undefined');
      return;
    }
    
    const dataText = typeof ctx.webAppData.data === 'string' 
      ? ctx.webAppData.data 
      : ctx.webAppData.data.text();
    
    const data = JSON.parse(dataText);
    console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ WebApp:', data);
    
    if (data.type === 'order') {
      await ctx.reply(`‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑!

üì¶ –í–∞—à –∑–∞–∫–∞–∑:
${data.items.map((item: any) => `‚Ä¢ ${item.name} - ${item.quantity} —à—Ç.`).join('\n')}

üí∞ –°—É–º–º–∞: ${data.totalPrice}‚ÇΩ

–ù–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π.`);
    } else if (data.type === 'proposal_request') {
      await ctx.reply(`üìÑ –ó–∞–ø—Ä–æ—Å –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω!

üë§ –ö–æ–Ω—Ç–∞–∫—Ç: ${data.userData?.firstName || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
üìß Email: ${data.userData?.email || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
üì± –¢–µ–ª–µ—Ñ–æ–Ω: ${data.userData?.phoneNumber || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}

–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –ö–ü –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç –µ–≥–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω—É—Ç.`);
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö WebApp:', error);
    await ctx.reply('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"
bot.action('back_to_menu', async (ctx) => {
  await ctx.answerCbQuery();
  
  const welcomeMessage = `üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Total Lookas!

üè¢ –ú—ã - –∫–æ–º–ø–∞–Ω–∏—è –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤—É –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π –æ–¥–µ–∂–¥—ã —Å –≤–∞—à–∏–º –ª–æ–≥–æ—Ç–∏–ø–æ–º.

üì± –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:`;

  await ctx.editMessageText(welcomeMessage, {
    reply_markup: {
      inline_keyboard: [
        [
          { text: 'üìñ –û –∫–æ–º–ø–∞–Ω–∏–∏', callback_data: 'about' },
          { text: 'üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã', callback_data: 'contact' }
        ],
        [
          { text: 'üëï –ö–∞—Ç–∞–ª–æ–≥', callback_data: 'catalog' },
          { text: 'üí∞ –ü–æ–ª—É—á–∏—Ç—å –ö–ü', callback_data: 'proposal' }
        ]
      ]
    }
  });
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
bot.on('message', async (ctx) => {
  await ctx.reply('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /start –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–æ–º');
});

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–æ—Ç–∞
export { bot };

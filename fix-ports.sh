#!/bin/bash

# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ—Ä—Ç–∞–º–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

SERVER_IP="89.104.65.237"
SERVER_PASS="Pji3PYKLpeOFgUoF"
DOMAIN="eskimoss.ru"

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ—Ä—Ç–∞–º–∏ –¥–ª—è $DOMAIN"
echo "=============================================="

# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ —Ä–µ—à–∞–µ–º –ø—Ä–æ–±–ª–µ–º—É
sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no root@$SERVER_IP "
    echo 'üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç –ø–æ—Ä—Ç 80...'
    lsof -i :80 || netstat -tulpn | grep :80
    
    echo 'üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã...'
    docker stop \$(docker ps -q) || true
    
    echo 'üßπ –û—á–∏—â–∞–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã Docker...'
    docker system prune -f
    
    echo 'üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Docker...'
    systemctl restart docker
    
    echo '‚è±Ô∏è –ñ–¥–µ–º 5 —Å–µ–∫—É–Ω–¥...'
    sleep 5
    
    echo 'üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã...'
    cd /home/tlbot/app
    docker-compose up -d
    
    echo 'üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...'
    docker ps
    
    echo 'üì° –û–±–Ω–æ–≤–ª—è–µ–º webhook...'
    curl -s 'https://api.telegram.org/bot7482550053:AAEd0XzEb3tkL1pryqkMYXn1YhoqJaMD7N0/setWebhook?url=https://$DOMAIN/api/bot'
    
    echo '‚úÖ –ì–æ—Ç–æ–≤–æ!'
"

echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∞–π—Ç–∞..."
curl -I -s https://$DOMAIN | head -1 || echo "–°–∞–π—Ç –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (DNS –µ—â–µ –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã)"

echo ""
echo "üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:"
echo ""
echo "1Ô∏è‚É£  –ù–∞—Å—Ç—Ä–æ–π—Ç–µ DNS –Ω–∞ reg.ru (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å–¥–µ–ª–∞–ª–∏):"
echo "   ‚Ä¢ A-–∑–∞–ø–∏—Å—å: @ -> $SERVER_IP"
echo "   ‚Ä¢ A-–∑–∞–ø–∏—Å—å: www -> $SERVER_IP"
echo ""
echo "2Ô∏è‚É£  –ü–æ–¥–æ–∂–¥–∏—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DNS (5-15 –º–∏–Ω—É—Ç)"
echo ""
echo "3Ô∏è‚É£  –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ BotFather:"
echo "   ‚Ä¢ /setdomain -> $DOMAIN"
echo "   ‚Ä¢ /setmenubutton -> –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ | https://$DOMAIN"
echo ""
echo "4Ô∏è‚É£  –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ Mini App —á–µ—Ä–µ–∑ –±–æ—Ç–∞"
echo ""
echo "‚ö†Ô∏è –ï—Å–ª–∏ —Å–∞–π—Ç –≤—Å–µ –µ—â–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ DNS"
echo "   –∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ä–≤–µ—Ä–æ–º."
echo ""
